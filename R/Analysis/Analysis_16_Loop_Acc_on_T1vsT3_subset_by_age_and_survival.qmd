---
title: "Table LMM and Cox acc on T1 lifespan vs T3 lifespan sub-setting by age"
author: "Jorge Martinez-Romero"
date: "2024-03-11"
format: html 
toc: true   
self-contained: true  
---
### Loop mortality subsetting samples  (Age)
Version of the analysis 9 including filtering the analyses to include different subset of samples by Age only in the analysis involving acceleration.
Goal: Determine validity of the models. Sub-setting starting from samples up to 55 weeks age up to 130 weeks by increments of 5 weeks -samples

```{r libraries, echo=TRUE, include=FALSE}
extrafont::loadfonts(device="win")
library("ggplot2")
library("tidyverse")
library("dplyr")
library("survival") 
library("Metrics")
library("h2o")
library("data.table")
library("Metrics")
library("eha")
library("kableExtra")
library("quantreg")
library("exact2x2")
library("utils")
library("LaplacesDemon")
library("lme4")

```


Load the held-out dataset form Analysis 9
```{r}
load("/data/martinezromerj2/0016_Hematological_clock_2023/Tables/Transitions/held_out_T1vsT3.Rdata")
```

### held-out

```{r}
#| echo: false
#| warning: false
formula4<-as.formula("scale(Acceleration) ~ Class + sex + scale(age_wk) + (1|strain) + (1|cohort) + (scale(age_wk) | ID)")
cutting<-c(seq(55,130, by=5))
results <- data.frame()
for (x in cutting){
AC<-AB %>% filter(age_wk<=x)
df_indep<-AC %>% group_by(ID) %>% 
  summarise(endpt=first(final_natural_death),
            final_lifespan=first(final_lifespan),
            cohort=first(cohort),
            dataset=first(dataset),
            strain=first(strain),
            final_natural_death=first(final_natural_death),
            sex=first(sex)) %>% tidyr::drop_na() %>% filter(final_lifespan!=0)
df_indep1 <-
  tmerge(data1=df_indep,
         data2=df_indep,
         id=ID,
         event=event(final_lifespan, endpt))

df_dep<-AC %>% select(ID,sex,strain,
                      final_lifespan,final_natural_death,Acceleration,age_wk) %>% 
  mutate(Acceleration=round(Acceleration,digit=2))

df_final <-
  tmerge(data1=df_indep1,
         data2=df_dep,
         id=ID,
         Acceleration=tdc(age_wk, Acceleration))

AA<-df_final%>% tidyr::drop_na() %>% mutate(age_wk=round(tstart,1),
                                                  tstart=round(tstart,1),
                                                  tstop=round(tstop,digits=1))
mod <- lmerTest::lmer(formula4, AC)
  p_value <- summary(mod)$coefficients[2,5]
  intercept <- summary(mod)$coefficients[2,1]
  beta_T3 <- summary(mod)$coefficients[2,2]
  AC$sa<-1
  samples<-aggregate(sa~Class,data=AC,sum)
  AD<-AC %>% distinct(ID, .keep_all = TRUE)
  mice<-aggregate(sa~Class,data=AD,sum)
  # Create a temporary dataframe to store results for this iteration
Y<-Surv(time = AA$tstart,time2 = AA$tstop,AA$event)
formula1<-as.formula("Y~Acceleration+age_wk+sex+strain")
formula2<-as.formula("Y~Acceleration+strata(age_wk)+strata(cohort)+strata(sex)+strata(strain)")

mod1<-coxph(formula1,id=ID,data = AA)
#mod2<-phreg(formula2, dist="gompertz",param="rate",data=AA)
# 
CIup<-round(exp(summary(mod1)$coefficients[1,1]+1.96*summary(mod1)$coefficients[1,3]),digits = 4)
CIdown<-round(exp(summary(mod1)$coefficients[1,1]-1.96*summary(mod1)$coefficients[1,3]),digits = 4)
HRCox<-paste0(round(summary(mod1)$coefficients[1,2],digits=4),"(",CIdown,"-",
                   CIup,")")
pvalCox<-round(summary(mod1)$coefficients[1,5],4)
temp_df <- data.frame(
    Dataset = x,
    P_Value = p_value,
    All_s=samples[1,2]+samples[2,2],
    All_m=mice[1,2]+mice[2,2],
    Samples_T1= samples[1,2],
    Mice_T1= mice[1,2],
    Samples_T3= samples[2,2],
    Mices_T3= mice[2,2],
    Cox_HR=HRCox,
    Cox_pval=pvalCox,
  )
results <- bind_rows(results, temp_df)
}
```

```{r}
results_slope<-results
write.csv(results_slope,file="/data/martinezromerj2/0016_Hematological_clock_2023/Tables/Output/results_slope.csv")
```

### Plot

```{r, eval=FALSE}
ZZ<-ggplot(data = AC, aes(x = age_wk, y = Acceleration, colour = Class))+
  geom_smooth(method = "lm", size=1, se=T) +
  geom_jitter(alpha=0.1, size=1)+ylim(-60,+60)+ xlim(0,160)+
  theme(legend.position = "bottom",
        legend.text=element_text(size=4),
        legend.title = element_text(size = 5),
        panel.background = element_rect(fill = "white"),
        axis.text = element_text(size = 5),
        plot.subtitle = element_text(size = 4),
        axis.title = element_text(size = 7),
        panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5),
        panel.grid.major = element_line(size = 0.15, linetype = 'solid',
                                        colour = "grey"), 
        panel.grid.minor = element_line(size = 0.15, linetype = 'solid',
                                        colour = "grey"))+
  scale_color_manual("Lifespan",values=c("Red","Dark green"))+
  xlab("Chronological age (weeks)")+
  ylab("Age acceleration")+
  annotate(geom="text", x=75, y=35, label=paste0("pval = ",as.character(temp_df[1,2],20)),
           color="Black",size = 2)

ggsave(paste0("/data/martinezromerj2/0016_Hematological_clock_2023/Plots/T1vsT3/Longitudinal_up_to_",x,"weeks.tiff",sep=""),
       ZZ, device = "tiff", dpi = 300,width = 6, height = 7,
       units = c("cm"))
```
